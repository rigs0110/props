name: Update pages from Notion
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # daily 3:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sanity check secrets
        run: |
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then echo "❌ NOTION_TOKEN missing"; exit 1; fi
          if [ -z "${{ secrets.NOTION_DB_ID }}" ]; then echo "❌ NOTION_DB_ID missing"; exit 1; fi
          echo "✅ Secrets present"

      - name: Setup Python
        run: |
          python3 --version
          pip install --upgrade pip
          pip install requests

      - name: Quick Notion probe (prints real error if any)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          python - << 'PY'
          import os, requests, json
          tok = os.environ["NOTION_TOKEN"]; db = os.environ["NOTION_DB_ID"]
          h = {"Authorization": f"Bearer {tok}", "Notion-Version": "2022-06-28", "Content-Type":"application/json"}
          r = requests.post(f"https://api.notion.com/v1/databases/{db}/query", headers=h, json={})
          print("HTTP", r.status_code)
          try:
            data = r.json()
          except Exception as e:
            print("❌ JSON parse error:", e); print(r.text); raise SystemExit(1)
          if "results" in data:
            print(f"✅ Got {len(data['results'])} rows from Notion")
          else:
            print("❌ Notion error payload:\n", json.dumps(data, indent=2))
            raise SystemExit(1)
          PY

      - name: Generate markdown pages
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          mkdir -p content
          python3 scripts/notion_to_md.py content/

      - name: Commit content (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add content/*.md 2>/dev/null || true
          git diff --cached --quiet || git commit -m "Update pages from Notion"
          git push || true
      - name: Generate markdown pages
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          mkdir -p content
          python3 scripts/notion_to_md.py content/      - name: Commit and push generated content
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add content
          git commit -m "Update pages from Notion" || echo "No changes to commit"
          git push

