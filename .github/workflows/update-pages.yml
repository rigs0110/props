name: Update pages from Notion

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # allow pushing to repo

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sanity check secrets
        run: |
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then echo "❌ NOTION_TOKEN missing"; exit 1; fi
          if [ -z "${{ secrets.NOTION_DB_ID }}" ]; then echo "❌ NOTION_DB_ID missing"; exit 1; fi
          echo "✅ Secrets present"

      - name: Setup Python
        run: |
          python3 --version
          pip install --upgrade pip
          pip install requests

      - name: Fetch data from Notion and generate markdown
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          mkdir -p content
          python - << 'PY'
          import os, requests, pathlib, re, json

          token = os.getenv("NOTION_TOKEN")
          db_id = os.getenv("NOTION_DB_ID")
          headers = {
              "Authorization": f"Bearer {token}",
              "Notion-Version": "2022-06-28",
              "Content-Type": "application/json"
          }

          r = requests.post(f"https://api.notion.com/v1/databases/{db_id}/query", headers=headers, json={})
          print("HTTP", r.status_code)
          data = r.json()
          rows = data.get("results", [])
          print("Got", len(rows), "rows")

          out_dir = pathlib.Path("content")
          out_dir.mkdir(exist_ok=True)

          for row in rows:
              props = row.get("properties", {})
              title = props.get("Name", {}).get("title", [])
              name = title[0]["plain_text"] if title else "Unknown"
              url = props.get("Landing URL", {}).get("url", "")
