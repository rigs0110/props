name: Update pages from Notion

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # <-- allows the workflow to push to your repo

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sanity check secrets
        run: |
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then echo "❌ NOTION_TOKEN missing"; exit 1; fi
          if [ -z "${{ secrets.NOTION_DB_ID }}" ]; then echo "❌ NOTION_DB_ID missing"; exit 1; fi
          echo "✅ Secrets present"

      - name: Setup Python
        run: |
          python3 --version
          pip install --upgrade pip
          pip install requests

      - name: Quick Notion probe (check connection)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          python - << 'PY'
          import os, requests, json
          tok = os.environ["NOTION_TOKEN"]; db = os.environ["NOTION_DB_ID"]
          h = {"Authorization": f"Bearer {tok}", "Notion-Version": "2022-06-28", "Content-Type":"application/json"}
          r = requests.post(f"https://api.notion.com/v1/databases/{db}/query", headers=h, json={})
          print("HTTP", r.status_code)
          try:
              data = r.json()
          except Exception as e:
              print("❌ JSON parse error:", e); print(r.text); raise SystemExit(1)
          if "results" in data:
              print(f"✅ Notion connected. Rows: {len(data['results'])}")
          else:
              print("❌ Notion error payload:\n", json.dumps(data, indent=2))
              raise SystemExit(1)
          PY

      - name: Generate markdown pages
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          mkdir -p content
          python - << 'PY'
          import os, requests, pathlib, re

          NOTION_TOKEN = os.getenv("NOTION_TOKEN")
          DB_ID = os.getenv("NOTION_DB_ID")

          headers = {
              "Authorization": f"Bearer {NOTION_TOKEN}",
              "Notion-Version": "2022-06-28",
              "Content-Type": "application/json",
          }

          def slugify(s): 
              return re.sub(r'[^a-z0-9-]+', '-', (s or '').lower()).strip('-') or 'firm'

          r = requests.post(f"https://api.notion.com/v1/databases/{DB_ID}/query", headers=headers, json={})
          data = r.json()
          rows = data.get("results", [])
          print(f"Got {len(rows)} rows")
          out_dir = pathlib.Path("content")
          out_dir.mkdir(exist_ok=True)

          for row in rows:
              props = row.get("properties", {})
              title = props.get("Name", {}).get("title", [])
              name = title[0]["plain_text"] if title else "Unknown Firm"
              url = props.get("Landing URL", {}).get("url", "")
