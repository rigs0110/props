name: Notion probe
on:
  workflow_dispatch:

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets exist
        run: |
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then echo "❌ NOTION_TOKEN missing"; exit 1; fi
          if [ -z "${{ secrets.NOTION_DB_ID }}" ]; then echo "❌ NOTION_DB_ID missing"; exit 1; fi
          echo "✅ Secrets present"

      - name: Test Notion API
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          python - << 'PY'
          import os, requests, json
          h={"Authorization":f"Bearer {os.environ['NOTION_TOKEN']}",
             "Notion-Version":"2022-06-28","Content-Type":"application/json"}
          url=f"https://api.notion.com/v1/databases/{os.environ['NOTION_DB_ID']}/query"
          r=requests.post(url, headers=h, json={})
          print("HTTP", r.status_code)
          try:
            data=r.json()
          except Exception as e:
            print("❌ JSON parse error:", e); print(r.text); raise SystemExit(1)
          if "results" in data:
            print(f"✅ Notion connected. Rows: {len(data['results'])}")
          else:
            print("❌ Notion error payload:\n", json.dumps(data, indent=2))
            raise SystemExit(1)
          PY
